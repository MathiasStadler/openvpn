# OPENVPN

| meanly for jog my mind I'm an old always plying child

## motivation

- prepare a sbc (Orange Pi zero or Raspi) for a multi port (1097,80,443) openvpn gateway behind a AVM Fritzbox at home.

## sources

- all credits goes to the writer

```txt
# manpage openvpn 2.4
https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage

# install pivpn in german
https://www.kuketz-blog.de/pivpn-raspberry-pi-mit-openvpn-raspberry-pi-teil3/

# run concurrent openvpn instance
https://www.hugeserver.com/kb/openvpn-multiple-ports/

# install openvpn 2.4.x on Ubuntu 16.04
https://medium.com/@ddavies_34472/deploying-openvpn-2-4-x-server-on-ubuntu-16-04-xenial-within-aws-dbd7b9333c95

# overview settings in german
https://www.securai.de/veroeffentlichungen/blog/sichere-konfiguration-eines-vpn-mit-openvpn/
```

## env

- Orange Pi zero H2+ 512 MByte, EFI boot , SSD 60GB
- Linux vpn-home 4.14.65-sunxi #68 SMP Tue Aug 21 19:57:06 CEST 2018 armv7l GNU/Linux

```txt
>cat /etc/os-release
PRETTY_NAME="Debian GNU/Linux 9 (stretch)"
NAME="Debian GNU/Linux"
VERSION_ID="9"
VERSION="9 (stretch)"
ID=debian
```

## install os

- I'm always used the [Armbian](https://www.armbian.com/orange-pi-zero/) distro


## steps

- change hostname
- config static ip and Google dns server
- prepare the Fritzbox for DynDNS
- install pivpn


## change hostname

```bash
# set hostname
sudo hostnamectl set-hostname vpn-home

# check hostname
sudo hostnamectl

```

## set static ip and google dns

- used a ip address outside the DHCP range of the router, you should found the info on your WAN router

```bash
cat /etc/network/interfaces

# depend of available network
source /etc/network/interfaces.d/*
# Network is managed by Network manager
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 192.168.178.245
    netmask 255.255.255.0
    gateway 192.168.178.1
    dns-search fritz.box
    dns-nameservers 8.8.8.8 8.8.4.4

```

| REBOOOT the system for activate the settings safely

- check your ip

```bash
> ip addr show eth0
 ```

- and hostname

```bash
> hostname

```

check dns

```bash
dig +short linux.org

```

## prepare the Fritzbox/Router for dynamic DNS

- create a login in any dynamic DNS service
- I'm used the AVM Fritzbox service
- **Check** you can ping **and** resolve your router with the dynamic dns name

```bash
ping <dynamic dns name>
# and your dynamic dns name
dig +short <dynamic dns name>
```

## enable port forwarding on your Fritzbox/router

- enable filter port forwarding on your fritzbox/router for
  - UDP/1194
  - TCP/80
  - TCP/443

## edit your iptables config

```bash
>cat /etc/iptables/rules.v4
# Generated by iptables-save v1.6.0 on Mon Nov 12 11:38:56 2018
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.9.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.10.0.0/24 -o eth0 -j MASQUERADE
COMMIT
# Completed on Mon Nov 12 11:38:56 2018
# Generated by iptables-save v1.6.0 on Mon Nov 12 11:38:56 2018
*filter
:INPUT ACCEPT [456:391734]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [356:86569]
COMMIT
```

## reload your iptables config

```bash

# reload
>iptables-restore </etc/iptables/rules.v4
# check
> iptables -L -t nat
> iptables -L -t filter

```

## install pivpn server

```bash
curl -L https://install.pivpn.io | bash
```

- follow all instruction
- used the dynamic dns name from step below
- select Elliptic Curve

## prepare pivpn client openvpn files

```bash
pivpn add
```

- follow the instruction
- you will found the ovpn profile in your home directory
- copy this to your client and used that with your openvpn client of your choice
  - e.g. [OpenVpn for Android](https://play.google.com/store/apps/details?id=de.blinkt.openvpn)

| I hope that works


## enable vpn service / start on each boot

```bash
# enable
sudo systemctl enable openvpn@server.service
#disable
sudo systemctl disable openvpn@server.service
# reenable after config change
sudo systemctl reenable openvpn@server.service
```


## create server.conf for port 80 and 443

- copy /etc/openvpn/server.conf for each instance

```bash
cp /etc/openvpn/server.conf /etc/openvpn/server2.conf
cp /etc/openvpn/server.conf /etc/openvpn/server3.conf
```

- edit port and port inside  /etc/openvpn/server2.conf to

```bash
# proto udp
proto tcp
# port 1194
port 443
#server 10.8.0.0 255.255.255.0
server 10.9.0.0 255.255.255.0
```

- edit port and port inside  /etc/openvpn/server3.conf to

```bash
# proto udp
proto tcp
# port 1194
port 80
# server 10.8.0.0 255.255.255.0
server 10.10.0.0 255.255.255.0
```

- Hint used diff for check that you only change these parameter

```bash
diff /etc/openvpn/server.conf /etc/openvpn/server2.conf
```

## enable the all server instances

```bash
sudo systemctl enable openvpn@server.service
sudo systemctl enable openvpn@server2.service
sudo systemctl enable openvpn@server3.service
```

## start all server instances

```bash
sudo systemctl start openvpn@server.service
sudo systemctl start openvpn@server2.service
sudo systemctl start openvpn@server3.service
```

## stop all server instaces

```bash
sudo systemctl stop openvpn@server.service
sudo systemctl stop openvpn@server2.service
sudo systemctl stop openvpn@server3.service
```

## check all server instances are listen to the port

```bash
>ss -aontul4 |egrep '1194|80|443'
udp    UNCONN     0      0         *:1194                  *:*
tcp    LISTEN     0      1         *:443                   *:*
tcp    LISTEN     0      1         *:80                    *:*
```

## see listen process on port

```bash
>ss -anotul4p |egrep '1194|80|443'
udp    UNCONN     0      0         *:1194                  *:*                   users:(("openvpn",pid=18851,fd=6))
tcp    LISTEN     0      1         *:443                   *:*                   users:(("openvpn",pid=18875,fd=6))
tcp    LISTEN     0      1         *:80                    *:*                   users:(("openvpn",pid=19065,fd=6))
```

## prepare opnv profile files for different port

- copy your OPVN profile file in your $HOME/ovpns for each server instance respectively for each port

```bash
cp $HOME/ovps/MyOpenVpn.ovpn $HOME/ovps/MyOpenVpnPort1194.ovpn
cp $HOME/ovps/MyOpenVpn.ovpn $HOME/ovps/MyOpenVpnPort80.ovpn
cp $HOME/ovps/MyOpenVpn.ovpn $HOME/ovps/MyOpenVpnPort443.ovpn
```

- edit your file PVN profile file $HOME/ovps/MyOpenVpnPort1194.ovpn

  - NO CHANGE

- change your file OPVN profile file $HOME/ovps/MyOpenVpnPort80.ovpn

```bash
# proto udp
proto tcp
#remote <YOUR DYNAMIC DNS NAME> 1194
remote <YOUR DYNAMIC DNS NAME> 80

```

- change your file OPVN profile file $HOME/ovps/MyOpenVpnPort443.ovpn

```bash
# proto udp
proto tcp
#remote <YOUR DYNAMIC DNS NAME> 1194
remote <YOUR DYNAMIC DNS NAME> 80
```

- copy to client and have connect over the port

## enable daily reboot

- for any reason that the openvpn would not more operated

```bash
sudo cat << EOF >/etc/cron.d/daily-reboot
# The first element of the path is a directory where the debian-sa1
# script is located
PATH=/usr/lib/sysstat:/usr/sbin:/usr/sbin:/usr/bin:/sbin:/bin


# daily reboot
59 23 * * * root /sbin/shutdown -Fr now
EOF

# activate /etc/cron.d
sudo touch /etc/cron.d

# display last reboot time
last -x|grep shutdown | head -1

```