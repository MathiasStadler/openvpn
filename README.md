# OPENVPN

| meanly for jog my mind I'm an old always plying child

## motivation

- prepare a sbc (Orange Pi zero or Raspi) for a multi port (1097,80,443) openvpn gateway behind a AVM Fritzbox at home.

## sources

- all credits goes to the writer

```txt
# manpage openvpn 2.4
https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage

# install pivpn in german
https://www.kuketz-blog.de/pivpn-raspberry-pi-mit-openvpn-raspberry-pi-teil3/

# run concurrent openvpn instance
https://www.hugeserver.com/kb/openvpn-multiple-ports/

# install openvpn 2.4.x on Ubuntu 16.04
https://medium.com/@ddavies_34472/deploying-openvpn-2-4-x-server-on-ubuntu-16-04-xenial-within-aws-dbd7b9333c95

# overview settings in german
https://www.securai.de/veroeffentlichungen/blog/sichere-konfiguration-eines-vpn-mit-openvpn/
```

## env

- Orange Pi zero H2+ 512 MByte, EFI boot , SSD 60GB
- Linux vpn-home 4.14.65-sunxi #68 SMP Tue Aug 21 19:57:06 CEST 2018 armv7l GNU/Linux

```txt
>cat /etc/os-release
PRETTY_NAME="Debian GNU/Linux 9 (stretch)"
NAME="Debian GNU/Linux"
VERSION_ID="9"
VERSION="9 (stretch)"
ID=debian
```

## install os

- I'm always used the [Armbian](https://www.armbian.com/orange-pi-zero/) distro


## steps

- change hostname
- config static ip and Google dns server
- prepare the Fritzbox for DynDNS
- install pivpn


## change hostname

```bash
# set hostname
sudo hostnamectl set-hostname vpn-home

# check hostname
sudo hostnamectl

```

## set static ip and google dns

- used a ip address outside the DHCP range of the router, you should found the info on your WAN router

```bash
cat << EOF | sudo tee /etc/network/interfaces

# depend of available network
source /etc/network/interfaces.d/*
# Network is managed by Network manager
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 192.168.178.248
    netmask 255.255.255.0
    gateway 192.168.178.1
    dns-search fritz.box
    dns-nameservers 8.8.8.8 8.8.4.4

EOF
```

| REBOOOT the system for activate the settings safely

- check your ip

```bash
> ip addr show eth0
 ```

- and hostname

```bash
> hostname

```

check dns

```bash
dig +short linux.org

```

## prepare the Fritzbox/Router for dynamic DNS

- create a login in any dynamic DNS service
- I'm used the AVM Fritzbox service
- **Check** you can ping **and** resolve your router with the dynamic dns name

```bash
ping <dynamic dns name>
# and your dynamic dns name
dig +short <dynamic dns name>
```

## install pivpn server

```bash
sudo curl -L https://install.pivpn.io | sudo bash
```

- follow all instruction
- select always the preselect default
- used dynamic dns and take the dns name from step below
- select Elliptic Curve 538
- used the dns that you like or just select default
- your dns name is **WITHOUT** protocol prefix and port number :-)

## which package installed openvpn ( maybe interesting)

```bash
# before you instal openvpn
>dpkg -l | grep ^ii | sed 's/^[^ ]* *\([^ ]*\) *\([^ ]*\).*/\1_\2/'|sort > installed-packages_before_openvpn.txt
# after you installed openvpn
>dpkg -l | grep ^ii | sed 's/^[^ ]* *\([^ ]*\) *\([^ ]*\).*/\1_\2/'|sort > installed-packages_after_openvpn.txt
# compare
>diff -u installed-packages_before_openvpn.txt installed-packages_after_openvpn.txt|grep ^+
+iptables-persistent_1.0.4+nmu2
+libpkcs11-helper1:armhf_1.21-1
+netfilter-persistent_1.0.4+nmu2
+openvpn_2.4.0-6+deb9u2
```

## enable port forwarding on your Fritzbox/router

- enable filter port forwarding on your fritzbox/router for
  - UDP/1194
  - TCP/80
  - TCP/443

## edit your iptables config

```bash
# create directory
mkdir -p /etc/iptables

# write iptables config 
>cat << EOF |sudo tee /etc/iptables/rules.v4
# Generated by iptables-save v1.6.0 on Mon Nov 12 11:38:56 2018
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.9.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.10.0.0/24 -o eth0 -j MASQUERADE
COMMIT
# Completed on Mon Nov 12 11:38:56 2018
# Generated by iptables-save v1.6.0 on Mon Nov 12 11:38:56 2018
*filter
:INPUT ACCEPT [456:391734]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [356:86569]
COMMIT

EOF
```

## reload your iptables config

```bash
# reload
>sudo iptables-restore </etc/iptables/rules.v4
# check
> sudo iptables -L -t nat
> sudo iptables -L -t filter
```

## prepare pivpn client and create openvpn profile file

```bash
pivpn add
```

- follow the instruction
- you will found the ovpn profile file in your home directory
- copy this to your client and used that with your openvpn client of your choice
  - e.g. [OpenVpn for Android](https://play.google.com/store/apps/details?id=de.blinkt.openvpn)

| I hope that works

## enable vpn service / start on each boot

```bash
# enable
sudo systemctl enable openvpn@server.service
#disable
sudo systemctl disable openvpn@server.service
# reenable after config change
sudo systemctl reenable openvpn@server.service
```

## create server.conf for port 80 and 443

- copy /etc/openvpn/server.conf for each instance

```bash
sudo cp /etc/openvpn/server.conf /etc/openvpn/server2.conf
sudo cp /etc/openvpn/server.conf /etc/openvpn/server3.conf
```

- edit port and port inside  /etc/openvpn/server2.conf to

```bash
# proto udp
proto tcp
# port 1194
port 443
#server 10.8.0.0 255.255.255.0
server 10.9.0.0 255.255.255.0
```

- edit port and port inside  /etc/openvpn/server3.conf to

```bash
# proto udp
proto tcp
# port 1194
port 80
# server 10.8.0.0 255.255.255.0
server 10.10.0.0 255.255.255.0
```

- Hint used diff for check that you only change these parameter

```bash
diff /etc/openvpn/server.conf /etc/openvpn/server2.conf
```

## enable the all server instances

```bash
sudo systemctl enable openvpn@server.service
sudo systemctl enable openvpn@server2.service
sudo systemctl enable openvpn@server3.service
```

## start all server instances

```bash
sudo systemctl start openvpn@server.service
sudo systemctl start openvpn@server2.service
sudo systemctl start openvpn@server3.service
```

## stop all server instaces

```bash
sudo systemctl stop openvpn@server.service
sudo systemctl stop openvpn@server2.service
sudo systemctl stop openvpn@server3.service
```

## check all server instances are listen to the port

```bash
>sudo ss -aontul4 |egrep '1194|80|443'
udp    UNCONN     0      0         *:1194                  *:*
tcp    LISTEN     0      1         *:443                   *:*
tcp    LISTEN     0      1         *:80                    *:*
```

## see listen process on port

```bash
>sudo ss -anotul4p |egrep '1194|80|443'
udp    UNCONN     0      0         *:1194                  *:*                   users:(("openvpn",pid=18851,fd=6))
tcp    LISTEN     0      1         *:443                   *:*                   users:(("openvpn",pid=18875,fd=6))
tcp    LISTEN     0      1         *:80                    *:*                   users:(("openvpn",pid=19065,fd=6))
```

## prepare openvpn profile files for different port

- copy your OPVN profile file in your $HOME/ovpns for each server instance respectively for each port

```bash
MY_OPEN_VPN_PROFILE="MyOpenVpnProfile"
PASSWORD="ChangeMe"

# change directory
cd $HOME/ovpns/

# create a certificate
sudo pivpn add --name $MY_OPEN_VPN_PROFILE --password $PASSWORD

cp $HOME/ovpns/$MY_OPEN_VPN_PROFILE.ovpn $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port1194.ovpn
cp $HOME/ovpns/$MY_OPEN_VPN_PROFILE.ovpn $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port80.ovpn
cp $HOME/ovpns/$MY_OPEN_VPN_PROFILE.ovpn $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port443.ovpn

# no change profile file $HOME/ovps/$MY_OPEN_VPN_PROFILE_Port1194.ovpn (default port)

# change protocol to tcp in file $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port80.ovpn
sed -i 's/proto udp/proto tcp/g' $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port80.ovpn

# change port in file $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port80.ovpn
sed -i '/^remote/s/1194/80/' $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port80.ovpn

# change protocol to tcp in file $HOME/ovps/${MY_OPEN_VPN_PROFILE}_Port443.ovpn
sed -i 's/proto udp/proto tcp/g' $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port443.ovpn

# change port in file $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port443.ovpn
sed -i '/^remote/s/1194/443/' $HOME/ovpns/${MY_OPEN_VPN_PROFILE}_Port443.ovpn

```

- copy the profile carefully to your device NOT VIA EMAIL

## enable daily reboot

- for any reason that the openvpn would not more operated

```bash
sudo cat << EOF >/etc/cron.d/daily-reboot
# The first element of the path is a directory where the debian-sa1
# script is located
PATH=/usr/lib/sysstat:/usr/sbin:/usr/sbin:/usr/bin:/sbin:/bin


# daily reboot
59 23 * * * root /sbin/shutdown -Fr now
EOF

# activate /etc/cron.d
sudo touch /etc/cron.d

# display last reboot time
last -x|grep shutdown | head -1

```

## android openvpn and afwall+

```txt
#architecture Moto G falcon => arm
https://de.wikipedia.org/wiki/Motorola_Moto_G

# Download suaddon fro lineageos arm version
https://download.lineageos.org/extras

download zip to your device

# How to Root Lineage OS with SU addon zip:
from here => https://androidflagship.com/25445-how-to-root-lineage-os-with-su-addon-zip
```

- Boot your device into TWRP recovery;
- Tap on Install;
- Then, select the Lineage SU addon zip file that you have transferred before;
- After selecting the .zip file, do Swipe to Confirm Flash on the bottom of screen to begin the flashing process;
- With the Lineage SU addon being flashed, you’ll get the usual Reboot System option, so select it;
- Now, you must enable Developer options: for that, go to Settings » About phone » Tap seven times on Build number;
- Find your way back into the Settings main menu and open Developer options from there;
- Look for Root access setting. Have you found it? You must now set it to Apps and ADB or Apps only, as per your need.

- install FDroid

- install AfWall+

- fw rules for android
https://www.kuketz-blog.de/afwall-wie-ich-persoenlich-die-android-firewall-nutze/
